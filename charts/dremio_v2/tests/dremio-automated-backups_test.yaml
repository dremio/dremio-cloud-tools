templates:
  - dremio-automated-backups.yaml
tests:
  - it: template should not render if backups are disabled
    set:
      coordinator:
        backups:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: template should render if backups are enabled
    set:
      coordinator:
        backups:
          enabled: true
    asserts:
      - hasDocuments:
          count: 1
  - it: coordinator.backup.schedule should be configurable
    set:
      coordinator:
        backups:
          enabled: true
          schedule: "0 22 * * 1-5"
    asserts:
      - equal:
          path: spec.schedule
          value: "0 22 * * 1-5"
  - it: distStorage should be configurable for AWS
    set:
      coordinator:
        backups:
          enabled: true
      distStorage:
        type: "aws"
        aws:
          bucketName: "test-aws-bucket"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:latest
            imagePullPolicy: IfNotPresent
            command:
              - /bin/sh
            args:
              - -c
              - |
                kubectl exec -i -t dremio-master-0
                --container dremio-master-coordinator
                -- /opt/dremio/bin/dremio-admin backup
                -l -d dremioS3:///test-aws-bucket/backups
          restartPolicy: OnFailure
