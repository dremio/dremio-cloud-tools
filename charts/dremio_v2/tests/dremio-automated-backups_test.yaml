templates:
  - dremio-automated-backups.yaml
tests:
  - it: template should not render if backups are disabled
    asserts:
      - hasDocuments:
          count: 0
  - it: template should render if backups are enabled
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
      distStorage:
        type: aws
    asserts:
      - hasDocuments:
          count: 1
  - it: backup.schedule should be configurable
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "0 22 * * 1-5"
      distStorage:
        type: aws
    asserts:
      - equal:
          path: spec.schedule
          value: "0 22 * * 1-5"
  - it: distStorage should be configurable for AWS
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
      distStorage:
        type: "aws"
        aws:
          bucketName: "test-aws-bucket"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:1.28.4
            imagePullPolicy: IfNotPresent
            command: [
              "kubectl",
              "exec",
              "dremio-master-0",
              "--container",
              "dremio-master-coordinator",
              "--",
              "env",
              "DREMIO_MAX_HEAP_MEMORY_SIZE_MB=4096",
              "/opt/dremio/bin/dremio-admin",
              "backup",
              "-l",
              "-d",
              "dremioS3:///test-aws-bucket///backups",
            ]
          restartPolicy: OnFailure
  - it: distStorage should be configurable for GCP
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
      distStorage:
        type: "gcp"
        gcp:
          bucketName: "test-gcp-bucket"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:1.28.4
            imagePullPolicy: IfNotPresent
            command: [
              "kubectl",
              "exec",
              "dremio-master-0",
              "--container",
              "dremio-master-coordinator",
              "--",
              "env",
              "DREMIO_MAX_HEAP_MEMORY_SIZE_MB=4096",
              "/opt/dremio/bin/dremio-admin",
              "backup",
              "-l",
              "-d",
              "dremiogcs:///test-gcp-bucket///backups",
            ]
          restartPolicy: OnFailure
  - it: distStorage should be configurable for Azure Storage
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
      distStorage:
        type: "azureStorage"
        azureStorage:
          filesystem: "test-azure-adls"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:1.28.4
            imagePullPolicy: IfNotPresent
            command: [
              "kubectl",
              "exec",
              "dremio-master-0",
              "--container",
              "dremio-master-coordinator",
              "--",
              "env",
              "DREMIO_MAX_HEAP_MEMORY_SIZE_MB=4096",
              "/opt/dremio/bin/dremio-admin",
              "backup",
              "-l",
              "-d",
              "dremioAzureStorage://:///test-azure-adls///backups",
            ]
          restartPolicy: OnFailure
  - it: heapMemory should default to 4096 if 
        'masterCoordinator.automatedBackups.heapMemory' is not set
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
      distStorage:
        type: "azureStorage"
        azureStorage:
          filesystem: "test-azure-adls"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:1.28.4
            imagePullPolicy: IfNotPresent
            command: [
              "kubectl",
              "exec",
              "dremio-master-0",
              "--container",
              "dremio-master-coordinator",
              "--",
              "env",
              "DREMIO_MAX_HEAP_MEMORY_SIZE_MB=4096",
              "/opt/dremio/bin/dremio-admin",
              "backup",
              "-l",
              "-d",
              "dremioAzureStorage://:///test-azure-adls///backups",
            ]
          restartPolicy: OnFailure
  - it: heapMemory should be configurable
    set:
      masterCoordinator:
        automatedBackups:
          schedule: "* * * * *"
          heapMemory: 15000
      distStorage:
        type: "azureStorage"
        azureStorage:
          filesystem: "test-azure-adls"
    asserts:
      - contains:
          path: spec.jobTemplate.spec.template.spec.containers
          content:
            name: dremio-automated-backups
            image: bitnami/kubectl:1.28.4
            imagePullPolicy: IfNotPresent
            command: [
              "kubectl",
              "exec",
              "dremio-master-0",
              "--container",
              "dremio-master-coordinator",
              "--",
              "env",
              "DREMIO_MAX_HEAP_MEMORY_SIZE_MB=15000",
              "/opt/dremio/bin/dremio-admin",
              "backup",
              "-l",
              "-d",
              "dremioAzureStorage://:///test-azure-adls///backups",
            ]
          restartPolicy: OnFailure